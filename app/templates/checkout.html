{% extends 'layout.html' %}

{% block content %}
<div class="container mt-3">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card">
        <div class="card-body">
          <h2 class="card-title text-center mb-4">Checkout</h2>

          {% if cart_items %}
          <form method="post" action="{{ url_for('cart.checkout') }}" class="mb-4">
            {{ form.csrf_token }}

            <!-- Display the user's grocery cart -->
            <div class="card mb-4">
              <div class="card-body">
                <h3 class="card-title">Your Grocery Cart</h3>
                <table class="table table-bordered">
                  <thead class="table-success">
                    <tr>
                      <th>Product</th>
                      <th>Quantity</th>
                      <th>Price</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in cart_items %}
                    <tr>
                      <td>{{ item.product.brand }}</td>
                      <td>{{ item.quantity }}</td>
                      <td>Ksh. {{ item.product.unit_price * item.quantity }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Display the total amount of the order -->
            <div class="card mb-4">
              <div class="card-body">
                <h3 class="card-title">Total Amount: Ksh. {{ total_price }}</h3>
              </div>
            </div>

            <!-- Display the delivery details form if there is no existing address -->
            {% if not existing_address %}
            <div id="new-address-section">
              <div class="card mb-4">
                <div class="card-body">
                  <h3 class="card-title">Delivery Details</h3>
                   <div class="mb-3">
                    <label for="location" class="form-label">Select Location</label>
                    <select id="location" name="location" class="form-control" required>
                      <option value="" disabled selected>Select Location</option>
                      {% for location in locations %}
                      <option value="{{ location.id }}">{{ location.name }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="mb-3">
                    <label for="arealine" class="form-label">Select Arealine</label>
                    <select id="arealine" name="arealine" class="form-control" required disabled>
                      <option value="" disabled selected>Select Arealine</option>
                      <!-- Arealine options will be populated using JavaScript when a location is selected -->
                    </select>
                  </div>

                  <div class="mb-3">
                    <label for="nearest_place" class="form-label">Select Nearest Place</label>
                    <select id="nearest_place" name="nearest_place" class="form-control" required disabled>
                      <option value="" disabled selected>Select Nearest Place</option>
                      <!-- Nearest Place options will be populated using JavaScript when an arealine is selected -->
                    </select>
                  </div>

                  <div class="mb-3">
                    <label for="address_line" class="form-label">Delivery Address</label>
                    {{ form.address_line(class="form-control", required=true) }}
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

<div class="card mb-4">
              <div class="card-body">
                <h3 class="card-title">Additional Information</h3>
                <div class="mb-3">
                  <label for="additional_info" class="form-label">Special Instructions</label>
                  {{ form.additional_info(class="form-control") }}
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-body">
                <h3 class="card-title">Payment Method</h3>
                <div class="mb-3">
                  {{ form.payment_method.label }} {{ form.payment_method(class="form-control", required=true) }}
                </div>
              </div>
            </div>
            

            <button type="submit" class="btn btn-primary btn-lg btn-block">Place Order</button>
          </form>
          {% else %}
          <!-- Display a message if the user's grocery cart is empty -->
          <div class="alert alert-info text-center" role="alert">
            Your grocery cart is empty. <a href="{{url_for('main.product_listing')}}">EXPLORE OUR STORE</a> and add items before checking out.
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  $(document).ready(function () {
    // Toggle new address section based on the checkbox
    $('#use_saved_address').change(function () {
      $('#new-address-section').toggle(!this.checked);
    });

    // Toggle existing address section
    $('#change-address-btn').click(function () {
      $('#new-address-section').toggle();
    });
  });


$(document).ready(function () {
  // Fetch locations on page load
  $.ajax({
    url: "/admin/get_locations",
    type: "GET",
    beforeSend: function () {
      // Show loading spinner
      $("#location").prop("disabled", true).html("<option>Loading...</option>");
      $("#arealine, #nearest_place").prop("disabled", true).html("<option>Select Arealine</option>");
    },
    success: function (response) {
      // Update locations dropdown
      var locationsDropdown = $("#location");
      locationsDropdown.prop("disabled", false).empty();
      locationsDropdown.append('<option value="" disabled selected>Select Location</option>');
      $.each(response.locations, function (index, location) {
        locationsDropdown.append('<option value="' + location.id + '">' + location.name + "</option>");
      });
    },
  });

  // Handle location change
  $("#location").change(function () {
    var selectedLocation = $(this).val();

    // Fetch arealines based on the selected location
    $.ajax({
      url: `/admin/get_arealines/${selectedLocation}`,
      type: "GET",
      beforeSend: function () {
        // Show loading spinner
        $("#arealine").prop("disabled", true).html("<option>Loading...</option>");
        $("#nearest_place").prop("disabled", true).html("<option>Select Nearest Place</option>");
      },
      success: function (response) {
        // Update arealines dropdown
        var arealinesDropdown = $("#arealine");
        arealinesDropdown.prop("disabled", false).empty();
        arealinesDropdown.append('<option value="" disabled selected>Select Arealine</option>');
        $.each(response.arealines, function (index, arealine) {
          arealinesDropdown.append('<option value="' + arealine.id + '">' + arealine.name + "</option>");
        });
      },
    });
  });

  // Handle arealine change
  $("#arealine").change(function () {
    var selectedArealine = $(this).val();

    // Fetch nearest places based on the selected arealine
    $.ajax({
      url: `/admin/get_nearest_places/${selectedArealine}`,
      type: "GET",
      beforeSend: function () {
        // Show loading spinner
        $("#nearest_place").prop("disabled", true).html("<option>Loading...</option>");
      },
      success: function (response) {
        // Update nearest places dropdown
        var nearestPlacesDropdown = $("#nearest_place");
        nearestPlacesDropdown.prop("disabled", false).empty();
        nearestPlacesDropdown.append('<option value="" disabled selected>Select Nearest Place</option>');
        $.each(response.nearest_places, function (index, nearestPlace) {
          nearestPlacesDropdown.append('<option value="' + nearestPlace.id + '">' + nearestPlace.name + "</option>");
        });
      },
    });
  });
});
</script>
{% endblock %}
