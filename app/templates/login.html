{% extends 'layout.html' %}

{% block content %}
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card shadow-lg>
          <div class="card-body">
            <h2 class="mb-4 text-center">Login</h2>
            <form method="post">
              {{ form.hidden_tag() }}

              <div class="mb-3">
                <label for="{{ form.identifier.id }}" class="form-label">User Name/Email/Phone</label>
                {{ form.identifier(class="form-control", placeholder="Enter your username, email, or phone number") }}
              </div>

              <div class="mb-3">
                <label for="{{ form.password.id }}" class="form-label">Password</label>
                {{ form.password(class="form-control", placeholder="Enter your password") }}
              </div>

              {{ form.submit(class="btn btn-success w-100", value="Login") }}
            </form>

            <p class="mt-3 text-center">
              Don't have an account?
              <a href="{{ url_for('main.register') }}">Register here</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
<script>
// Function to refresh CSRF token in the background
function refreshCSRFTokenInBackground() {
    // Check if the CSRF token input field exists in the form
    var csrfTokenInput = document.querySelector('input[name="_csrf_token"]');
    if (csrfTokenInput) {
        // Get the current CSRF token value
        var currentToken = csrfTokenInput.value;

        // Check if the token is close to expiration (e.g., within 5 minutes of expiration)
        var expirationThreshold = 5 * 60 * 1000; // 5 minutes in milliseconds
        var tokenExpiryTime = parseInt(csrfTokenInput.getAttribute('data-expiration-time'), 10);
        var currentTime = new Date().getTime();
        if (tokenExpiryTime && tokenExpiryTime - currentTime <= expirationThreshold) {
            // Token is close to expiration or has expired, make an AJAX request to fetch a new token
            fetch('/refresh_csrf_token')
                .then(response => response.json())
                .then(data => {
                    // Update the CSRF token input field with the new token value
                    csrfTokenInput.value = data.csrf_token;
                    // Update the token expiration time attribute
                    csrfTokenInput.setAttribute('data-expiration-time', data.expiration_time);
                })
                .catch(error => {
                    console.error('Error refreshing CSRF token:', error);
                });
        }
    }
}

// Call the function to refresh the CSRF token periodically (e.g., every 5 minutes)
setInterval(refreshCSRFTokenInBackground, 5 * 60 * 1000); // 5 minutes in milliseconds

</script>
{% endblock %}