{% extends 'layout.html' %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='styles/productlisting.css') }}">

<div class="container mt-5 mb-5">

    <!-- WhatsApp Section -->
    <div class="whatsapp-section mb-4">
        <a href="https://wa.me/c/254707632230" target="_blank" class="whatsapp-link">
            <i class="fab fa-whatsapp"></i> WhatsApp Us
        </a>
    </div>

    <!-- Category Carousel -->
    <div id="categoryCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <div class="d-flex flex-wrap justify-content-center">
                    <a href="{{ url_for('main.product_listing') }}" class="btn btn-outline-success m-2 category-btn">All</a>
                    {% for category in categories %}
                    <a href="{{ url_for('main.product_listing_by_category', category_id=category.id) }}" class="btn btn-outline-success m-2 category-btn">{{ category.name }}</a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div aria-live="polite" aria-atomic="true" class="position-relative">
        <div class="toast-container position-fixed end-0 p-3">
            <div id="cartToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Cart</strong>
                    <small>Just now</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    Added to cart successfully!
                </div>
            </div>
        </div>
    </div>

    <div class="row row-cols-2 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
        {% for product in products %}
        <div class="col">
            <div class="card product-card border-0 shadow-sm rounded-3">
                <div class="magnifier position-relative overflow-hidden">
                    {% set images_list = product.images | list %}
                    {% if images_list and images_list | length > 0 %}
                    <img data-src="{{ url_for('static', filename='uploads/' + images_list[0].cover_image) }}" loading="lazy" class="card-img-top product-image lazy" alt="{{ product.name }}">
                    {% else %}
                    <img data-src="{{ url_for('static', filename='alt_img.png') }}" loading="lazy" class="card-img-top product-image lazy" alt="Placeholder Image">
                    {% endif %}
                </div>
                <div class="card-body text-center">
                    <h5 class="card-title text-primary mb-1 product-name">{{ product.brand }}</h5>
                    <p class="card-text text-muted fs-6 mb-2">{{ product.description | truncate(80) }}</p>
                    <p class="card-text fw-bold" id="price-{{ product.id }}">Ksh <span class="current-price">{{ product.unit_price }}</span> / {{ product.unit_measurement }}</p>
                    
                    <!-- Add to Cart Form -->
                    <form class="add-to-cart-form" method="POST" action="{{ url_for('cart.add_to_cart', product_id=product.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        {% if product.varieties and product.varieties | length > 0 %}
                        <select class="form-select variety-select mb-3" name="variety_id" required>
                            <option value="" data-price="{{ product.unit_price }}">Select Variety</option>
                            {% for variety in product.varieties %}
                              <option value="{{ variety.id }}" data-price="{{ variety.price }}">{{ variety.name }} - Ksh {{ variety.price }}</option>
                            {% endfor %}
                        </select>
                        {% endif %}

                        <div class="d-flex justify-content-center mb-3">
                            <button class="btn btn-outline-danger quantity-btn" type="button" data-action="decrease">-</button>
                            <input type="number" class="form-control quantity-input text-center mx-2" name="quantity" value="1" min="1" max="{{ product.quantity_in_stock }}">
                            <button class="btn btn-outline-success quantity-btn" type="button" data-action="increase">+</button>
                        </div>

                        <button class="btn btn-success add-to-cart" type="submit">Add to Cart</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- JavaScript for Quantity Control and Price Update -->
    <script>
      document.querySelectorAll('.variety-select').forEach(select => {
          select.addEventListener('change', function() {
              const selectedOption = this.options[this.selectedIndex];
              const priceDisplay = this.closest('.add-to-cart-form').querySelector('.current-price');
              const selectedPrice = selectedOption.dataset.price;

              priceDisplay.textContent = selectedPrice;
          });
      });

      document.querySelectorAll('.quantity-btn').forEach(button => {
          button.addEventListener('click', function() {
              const action = this.getAttribute('data-action');
              const quantityInput = this.closest('.add-to-cart-form').querySelector('.quantity-input');
              let currentValue = parseInt(quantityInput.value);

              if (action === 'increase') {
                  currentValue++;
              } else if (action === 'decrease' && currentValue > 1) {
                  currentValue--;
              }

              quantityInput.value = currentValue;
          });
      });
    </script>

     
</div>

{% endblock %}
