{% extends 'layout.html' %}

{% block content %}
  <div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="text-center" style="max-width: 1000px;">
      <h1 class="mb-4">Product Listing</h1>
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-2">

        {% for product in products %}
          <div class="col">
            <div class="card product-card border-0">
              <div class="product-image-container text-center mb-3">
                {% if product.images %}
                  <img src="{{ url_for('static', filename='uploads/' + product.images[0].cover_image) }}" class="card-img-top product-image rounded-top" alt="{{ product.name }}">
                {% else %}
                  <img src="{{ url_for('static', filename='placeholder.jpg') }}" class="card-img-top product-image rounded-top" alt="Placeholder Image">
                {% endif %}
              </div>

              <div class="card-body text-center">
                <h5 class="card-title text-primary fs-6">{{ product.brand }}</h5>
                <p class="card-text text-muted fs-6">{{ product.description | truncate(120) }}</p>
                <p class="card-text fs-6"><strong>Price:</strong> Ksh {{ product.unit_price }} / {{ product.unit_measurement }}</p>
                <p class="card-text {% if product.quantity_in_stock < 5 %}text-danger{% endif %} fs-6"><strong>Stock:</strong> {{ product.quantity_in_stock }}</p>

                <form id="add-to-cart-form-{{ product.id }}" action="{{ url_for('cart.add_to_cart', product_id=product.id, quantity=1) }}" method="post" onsubmit="return showLoadingSpinner('{{ product.id }}')">
                  {{ form.csrf_token }}
                  <input type="hidden" id="quantity-input-{{ product.id }}" name="quantity" value="1">

                  <button type="submit" class="btn btn-primary btn-sm fs-6" id="add-to-cart-btn-{{ product.id }}">Add to Cart</button>
                  <div class="spinner-border text-primary d-none fs-6" role="status" id="loading-spinner-{{ product.id }}">
                    <span class="sr-only"></span>
                  </div>
                </form>
              </div>
            </div>
          </div>
        {% endfor %}

      </div>
    </div>
  </div>



  <script>
    async function getCurrentQuantity(productId) {
      try {
        const response = await fetch(`/api/cart/${productId}/quantity`);
        const data = await response.json();
        return data.quantity;
      } catch (error) {
        console.error('Error fetching quantity:', error);
        return 1; // Default to 1 if there's an error
      }
    }

    async function updateCartItem(productId, action) {
      const quantityInput = document.getElementById('quantity-input-' + productId);
      const loadingSpinner = document.getElementById('loading-spinner-' + productId);

      // Show loading spinner
      loadingSpinner.classList.remove('d-none');

      try {
        // Fetch the actual quantity in the cart
        const serverQuantity = await getCurrentQuantity(productId);

        // Update the quantity locally based on the action (increment or decrement)
        let currentQuantity = parseInt(quantityInput.value);
        if (action === 'increment') {
          currentQuantity++;
        } else if (action === 'decrement' && currentQuantity > 1) {
          currentQuantity--;
        }

        // Synchronize the displayed quantity with the actual quantity in the cart
        quantityInput.value = currentQuantity;

        // If the action is not 'increment' or 'decrement', set the quantity directly
        if (action !== 'increment' && action !== 'decrement') {
          quantityInput.value = serverQuantity;
        }
      } catch (error) {
        console.error('Error updating quantity:', error);
      } finally {
        // Hide loading spinner
        loadingSpinner.classList.add('d-none');
      }
    }

    // Define the showLoadingSpinner function
    function showLoadingSpinner(productId) {
      const loadingSpinner = document.getElementById('loading-spinner-' + productId);
      // Show loading spinner
      loadingSpinner.classList.remove('d-none');
      // You can add additional logic if needed
      return true; // or false based on your requirements
    }

    // Initial synchronization on page load
    document.addEventListener('DOMContentLoaded', async () => {
      {% for product in products %}
        const productId = '{{ product.id }}';
        await updateCartItem(productId, 'sync');
      {% endfor %}
    });
  </script>


{% endblock %}

