{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Shop for User</h2>

    <!-- User Dropdown for selecting the user -->
    <div class="form-group">
        <label for="user">Select User:</label>
        <select class="form-control" id="user" name="user" onchange="selectUser()">
            <option value="">-- Select a User --</option>
            {% for user in users %}
            <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Cart Display -->
    <div id="cart" class="mt-4">
        <h3>Cart for Selected User</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Unit Price (KSH)</th> <!-- Adjust to KSH if necessary -->
                    <th>Quantity</th>
                    <th>Subtotal (KSH)</th> <!-- Adjust to KSH if necessary -->
                    <th>Custom Description</th>
                </tr>
            </thead>
            <tbody id="cartItems">
                <!-- Cart items will be dynamically added here -->
            </tbody>
        </table>
        <div id="totalPrice"></div> <!-- Total price will be dynamically updated -->
        <button type="button" class="btn btn-success mt-2" onclick="placeOrder()">Place Order</button>
    </div>
</div>

<!-- Modal for Product Selection -->
<div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Select Product for User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Product Category Dropdown -->
                <div class="form-group">
                    <label for="category">Select Category:</label>
                    <select class="form-control" id="category" name="category" onchange="loadProducts(this.value)">
                        <option value="">-- Select a Category --</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Product Dropdown (Populated via AJAX) -->
                <div class="form-group">
                    <label for="product">Select Product:</label>
                    <select class="form-control" id="product" name="product">
                        <!-- Options populated dynamically via JavaScript -->
                    </select>
                </div>

                <!-- Quantity and Custom Description -->
                <div class="form-group">
                    <label for="quantity">Quantity:</label>
                    <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1">
                </div>
                <div class="form-group">
                    <label for="custom_description">Custom Description:</label>
                    <textarea class="form-control" id="custom_description" name="custom_description"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="addToCart()">Add to Cart</button>
                <button type="button" class="btn btn-primary" onclick="addAnotherItem()">Add Another Item</button>
            </div>
        </div>
    </div>
</div>

<!-- Order Summary Modal -->
<div class="modal fade" id="orderSummaryModal" tabindex="-1" role="dialog" aria-labelledby="orderSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderSummaryModalLabel">Order Summary</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="orderSummaryDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="continueShopping()">Continue Shopping</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden CSRF Token -->
<input type="hidden" id="csrf_token" value="{{ csrf_token() }}">

<!-- Loading Spinner -->
<div id="loadingSpinner" class="spinner-border text-primary" role="status" style="display:none;">
    <span class="sr-only">Loading...</span>
</div>

<script>
    // Function to handle user selection
    function selectUser() {
        var userId = document.getElementById('user').value;
        if (userId) {
            // Show the product selection modal
            $('#productModal').modal('show');

            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';

            // Fetch and display user's cart items
            fetchUserCart(userId);
        } else {
            // Hide the modal if no user is selected
            $('#productModal').modal('hide');
        }
    }

    // Function to fetch and display user's cart items
    function fetchUserCart(userId) {
        fetch(`/admin/admin/get_user_cart?user_id=${userId}`)
            .then(response => response.json())
            .then(data => {
                // Clear existing cart items
                document.getElementById('cartItems').innerHTML = '';
                var totalPrice = 0;

                // Populate cart items table
                data.cart_items.forEach(item => {
                    var newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${item.product_name}</td>
                        <td>${item.unit_price}</td>
                        <td>${item.quantity}</td>
                        <td>${item.subtotal}</td>
                        <td>${item.custom_description}</td>
                    `;
                    document.getElementById('cartItems').appendChild(newRow);
                    totalPrice += item.subtotal;
                });

                // Display total price
                document.getElementById('totalPrice').innerHTML = `<strong>Total Price:</strong> Ksh. ${totalPrice.toFixed(2)}`;

                // Hide loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
            })
            .catch(error => {
                console.error('Error fetching user cart:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                // Optionally, show an error alert here
            });
    }

    // Function to load products based on selected category
    function loadProducts(categoryId) {
        var productSelect = document.getElementById('product');
        productSelect.innerHTML = '<option value="">-- Select a Product --</option>';

        if (categoryId) {
            fetch(`/admin/admin/get_products?category_id=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    data.products.forEach(product => {
                        var option = document.createElement('option');
                        option.value = product.id;
                        option.text = product.name;
                        productSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching products:', error));
        }
    }

    // Function to add item to the cart
    function addToCart() {
        var productId = document.getElementById('product').value;
        var quantity = document.getElementById('quantity').value;
        var customDescription = document.getElementById('custom_description').value;
        var userId = document.getElementById('user').value;
        var csrfToken = document.getElementById('csrf_token').value;

        // Validate form inputs
        if (!productId || quantity < 1) {
            alert('Please select a product and enter a valid quantity.');
            return;
        }

        fetch('/admin/admin/add_to_cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken  // Include CSRF token in the headers
            },
            body: JSON.stringify({
                user_id: userId,
                product_id: productId,
                quantity: quantity,
                custom_description: customDescription
            })
        })
        .then(response => response.json())
        .then(data => {
            // Update cart display
            fetchUserCart(userId);

            // Clear input fields for next item
            document.getElementById('product').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('custom_description').value = '';
        })
        .catch(error => console.error('Error adding to cart:', error));
    }

    // Function to add another item without closing the modal
    function addAnotherItem() {
        var productId = document.getElementById('product').value;
        var quantity = document.getElementById('quantity').value;
        var customDescription = document.getElementById('custom_description').value;
        var userId = document.getElementById('user').value;
        var csrfToken = document.getElementById('csrf_token').value;

        // Validate form inputs
        if (!productId || quantity < 1) {
            alert('Please select a product and enter a valid quantity.');
            return;
        }

        fetch('/admin/admin/add_to_cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken  // Include CSRF token in the headers
            },
            body: JSON.stringify({
                user_id: userId,
                product_id: productId,
                quantity: quantity,
                custom_description: customDescription
            })
        })
        .then(response => response.json())
        .then(data => {
            // Update cart display
            fetchUserCart(userId);

            // Clear input fields for next item
            document.getElementById('product').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('custom_description').value = '';
        })
        .catch(error => console.error('Error adding to cart:', error));
    }

    // Function to handle order placement
    function placeOrder() {
        var userId = document.getElementById('user').value;
        var csrfToken = document.getElementById('csrf_token').value;

        fetch('/admin/admin/place_order_for_user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                user_id: userId,
                // Add other required details if needed
            })
        })
        .then(response => response.json())
        .then(data => {
            // Handle success or display message
            alert(data.message);

            // Update UI with order total and details
            fetchUserCart(userId); // Update cart display after placing order
            displayOrderSummary(data.order); // Assuming 'data.order' contains updated order details

            // Optionally, clear the cart items UI here
            document.getElementById('cartItems').innerHTML = '';
            document.getElementById('totalPrice').innerHTML = '';

            // Close modal or update UI accordingly
            $('#orderSummaryModal').modal('show'); // Show order summary modal
        })
        .catch(error => console.error('Error placing order:', error));
    }

    // Function to display order summary
    function displayOrderSummary(order) {
        // Example: Display order details in a modal or another UI element
        var orderSummaryDetails = document.getElementById('orderSummaryDetails');
        orderSummaryDetails.innerHTML = `
            <p><strong>Order ID:</strong> ${order.order_id}</p>
            <p><strong>User ID:</strong> ${order.user_id}</p>
            <p><strong>Order Date:</strong> ${order.order_date}</p>
            <p><strong>Total Price:</strong> KSH ${order.total_price.toFixed(2)}</p>
            <h5>Order Items:</h5>
            <ul>
                ${order.order_items.map(item => `
                    <li>
                        <p><strong>Product Name:</strong> ${item.product_name}</p>
                        <p><strong>Quantity:</strong> ${item.quantity}</p>
                        <p><strong>Unit Price:</strong> KSH ${item.unit_price.toFixed(2)}</p>
                        <p><strong>Subtotal:</strong> KSH ${(item.quantity * item.unit_price).toFixed(2)}</p>
                        <p><strong>Custom Description:</strong> ${item.custom_description}</p>
                    </li>
                `).join('')}
            </ul>
        `;
        
        $('#orderSummaryModal').modal('show'); // Show order summary modal
    }

    // Function to continue shopping after viewing order summary
    function continueShopping() {
        // Close the order summary modal
        $('#orderSummaryModal').modal('hide');
        
        // Optionally, reset UI or perform other actions to prepare for the next shopping session
    }
</script>
{% endblock %}
